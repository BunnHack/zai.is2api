

# 🏴‍☠️ DarkKnight Toolkit - Zai.is 逆向工程指南

本工具包用于绕过 Zai.is 的前端加密机制（WebCrypto API），提取不可导出（Non-extractable）的私钥，并实现无浏览器环境下的 API 自动化对话。

## 📂 文件清单

| 文件名 | 类型 | 作用 |
| :--- | :--- | :--- |
| `注入.py` | Python | **第一步**：启动中毒浏览器，移除 SRI 校验，强制密钥可导出。 |
| `导出私钥.js` | JS | **第二步**：在中毒浏览器控制台中运行，提取并显示私钥 JSON。 |
| `x解码找fp.py` | Python | **辅助工具**：解码浏览器请求头，获取真实的指纹信息 (Fingerprint)。 |
| `zai逆向连续回复.py` | Python | **主程序**：使用提取的私钥和 Token 进行 API 对话。 |
| `x-注入.js` | JS | **可选**：如果你已有私钥，可用此脚本将其强制写入浏览器数据库。 |

---

## 🛠️ 1. 环境准备

确保安装了 Python 3.8+，并安装以下依赖库：

```bash
pip install playwright curl_cffi cryptography
playwright install  # 安装浏览器内核
```

---

## 🚀 2. 获取私钥 (核心步骤)

由于 Zai.is 使用 `extractable: false` 生成密钥，我们需要使用“中间人攻击”方式修改浏览器行为。

### 步骤 2.1：启动注入环境
运行 Python 脚本启动一个受控制的 Chromium 浏览器：

```bash
python 注入.py
```

*   **现象**：脚本会自动打开一个浏览器窗口，访问 `zai.is`。
*   **注意**：脚本会自动清空 IndexedDB 数据库，强迫网站重新生成密钥。
*   **等待**：等待页面完全加载，并出现登录/注册界面。此时，JS 环境已被“投毒”，新生成的密钥变成了 **可导出** 状态。

### 步骤 2.2：登录并提取
1. 在弹出的浏览器中，**手动登录**您的账号。
2. 按 `F12` 打开开发者工具 (DevTools)，切换到 **Console (控制台)** 标签。
3. 复制 `导出私钥.js` 的全部代码，粘贴到控制台并回车。
4. **结果**：
    *   屏幕会弹出提示 "🎉 成功了！"。
    *   控制台会打印出绿色的 `[最终战利品]` JSON 数据。
    *   **复制这个 JSON 对象**（包含 `d`, `x`, `y`, `crv` 等字段），保存备用。

---

## 🕵️ 3. 获取 Token 和指纹

我们需要从真实的浏览器请求中获取 API 认证信息。

1. 在刚才运行的浏览器中，保持开发者工具打开，切换到 **Network (网络)** 标签。
2. 在网页上随便发送一条消息。
3. 在 Network 列表中找到 `completions` 或 `chats` 相关的请求。
4. 查看 **Request Headers (请求头)**，找到以下两项：
    *   **Authorization**: 复制这个值（通常是 `Bearer` 开头）。
    *   **x-zai-darkknight**: 复制这个长字符串（这是加密的签名头）。

### 解码指纹 (Fingerprint)
1. 打开 `x解码找fp.py`。
2. 将刚才复制的 `x-zai-darkknight` 值填入 `REAL_HEADER` 变量。
3. 运行脚本：
   ```bash
   python x解码找fp.py
   ```
4. 查看输出，找到 `"fp"` 字段的内容（通常包含 `c`, `wgl` 等属性）。**复制这个字典对象**。

---

## 🤖 4. 配置并运行聊天机器人

现在您已集齐所有碎片，可以脱离浏览器运行了。

1. 打开 `zai逆向连续回复.py`。
2. 修改 **配置区域**：
    *   `CAPTURED_KEY_JSON`: 填入 **步骤 2.2** 获取的私钥 JSON。
    *   `USER_TOKEN`: 填入 **步骤 3** 获取的 Authorization Token。
    *   `BROWSER_FINGERPRINT`: 填入 **步骤 3** 解码出的 fp 字典。
3. 运行聊天脚本：

```bash
python zai逆向连续回复.py
```

*   **成功**：你将看到 "✅ 连接成功! 房间号: ..."，并可以输入内容与 AI 对话。

---

## 🔧 附录：高级用法

### 使用 `x-注入.js` (时光倒流)
如果你保存了之前的私钥，想让浏览器“恢复”到那个身份，而不需要重新登录或重新生成：

1. 打开 `x-注入.js`。
2. 将你的私钥填入 `MY_MASTER_KEY` 变量。
3. 在浏览器的控制台中运行此脚本。
4. 刷新页面，你将变回那个密钥对应的身份。

---

## ⚠️ 常见问题与排错

1.  **数据库卡死 / Pending**：
    *   如果在运行 `导出私钥.js` 时提示数据库卡住，请**关闭**开发者工具中的 `Application` 标签页，或者直接关闭开发者工具再重新打开 Console。
2.  **401 Unauthorized**：
    *   Token 过期了，请重新在浏览器抓包获取 `Authorization`。
3.  **403 Forbidden / 签名错误**：
    *   指纹 (`fp`) 与私钥不匹配，或者私钥与公钥不匹配。请确保 `x-zai-darkknight` 是由你提取的那个私钥对应的浏览器生成的。
4.  **Python 缺少模块**：
    *   请务必使用 `pip install curl_cffi`，普通的 `requests` 库无法模拟 Chrome 指纹（JA3/TLS），会被 Cloudflare 拦截。

---

> **免责声明**：本工具仅供安全研究和教育目的使用。请勿用于非法用途。
